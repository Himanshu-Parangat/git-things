name: Build Status Check

permissions:
  actions: write
  checks: write
  contents: write
  pull-requests: write
  statuses: write

on:
  workflow_dispatch:
    inputs:
      PullRequestLink:
        description: "Enter the Pull Request Link"
        required: true

jobs:
  Context-Preserver:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch PR data
        id: GetPullRequestData
        run: |
          gh pr view "${{ github.event.inputs.PullRequestLink }}" --json number,headRefOid,headRefName,url,title,changedFiles,commits,files > PullRequestData.txt
          if [ $? -ne 0 ]; then
            echo "Error: Failed to fetch PR data."
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Environment
        id: loadEnvironment
        run: |
          echo "PR_NUMBER=$(jq -r '.number' PullRequestData.txt)" >> $GITHUB_ENV
          echo "PR_SHA=$(jq -r '.headRefOid' PullRequestData.txt)" >> $GITHUB_ENV
          echo "PR_URL=$(jq -r '.url' PullRequestData.txt)" >> $GITHUB_ENV
          echo "PR_Branch=$(jq -r '.headRefName' PullRequestData.txt)" >> $GITHUB_ENV
          echo "PR_Title=$(jq -r '.title' PullRequestData.txt)" >> $GITHUB_ENV
          echo "PR_Total_changedFiles_count=$(jq -r '.changedFiles' PullRequestData.txt)" >> $GITHUB_ENV
          echo "PR_Total_changedFiles=$(jq -rc '.files | map(.path)'  PullRequestData.txt | base64 | tr -d '\n')" >> $GITHUB_ENV
          echo "PR_commits_titel=$( jq -rc '.commits | map(.messageHeadline)' PullRequestData.txt | base64 | tr -d '\n')" >> $GITHUB_ENV
          echo "START_TIME"=$(node -e "
            const d = new Date();
            const year = d.getFullYear();
            const month = d.toLocaleString('en-US', { month: 'short' });
            const day = d.getDate();
            const hours = d.getHours();
            const minutes = d.getMinutes();
            const seconds = d.getSeconds();
            console.log(\`\${year} \${month} \${day}, \${hours}:\${minutes}:\${seconds}\`);
          ") >> $GITHUB_ENV
          # echo "Target_BUILD=$(echo '["test","foo","bar"]' | base64 | tr -d '\n' )" >> $GITHUB_ENV

      - name: File Change Target Mapping
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const totalChangedFilesList = JSON.parse(Buffer.from(process.env.PR_Total_changedFiles, 'base64').toString('utf-8'))
              .filter(item => item.trim() !== '')

            const patterns = [
              { pattern: "^firewall/reverseProxy/*", target: "reverseProxy" },
              { pattern: "^firewall/waf/*", target: "waf" },
              { pattern: "^testing-env/application/*", target: "application" },
              { pattern: "^testing-env/server/*", target: "server" },
              { pattern: "^testing-env/simulator/*", target: "simulator" },
              { pattern: "^docs/*", target: "documentation" },
              { pattern: "^Makefile", target: "all" },
            ];

            const getTarget = (filePath) => {
              for (const { pattern, target } of patterns) {
                const regex = new RegExp(pattern);
                if (regex.test(filePath)) {
                  return target;
                }
              }
              return "skip";
            };

            const targets = totalChangedFilesList.map(item => getTarget(item));
            core.exportVariable(
              'Target_BUILD',
              Buffer.from(JSON.stringify(targets.includes("all") ? ["all"] : targets))
                .toString('base64')
                .replace(/\n/g, '')
            );

      # In_progress
      - name: Create and Run Check(InProgress)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const totalChangedFilesList = JSON.parse(Buffer.from(process.env.PR_Total_changedFiles, 'base64').toString('utf-8'))
              .filter(item => item.trim() !== '')
              .map(item => `<li><code>${item}</code></li>`)
              .join('');

            const commitMessagesList = JSON.parse(Buffer.from(process.env.PR_commits_titel, 'base64').toString('utf-8'))
              .filter(item => item.trim() !== '')
              .map(item => `<li><code>${item}</code></li>`)
              .join('');

            const started_at = process.env.START_TIME
            const finished_At = (function() {
              const d = new Date();
              const year = d.getFullYear();
              const month = d.toLocaleString('en-US', { month: 'short' });
              const day = d.getDate();
              const hours = d.getHours();
              const minutes = d.getMinutes();
              const seconds = d.getSeconds();

              return `${year} ${month} ${day}, ${hours}:${minutes}:${seconds}`;
            })();

            const components_build_target = JSON.parse(Buffer.from(process.env.Target_BUILD, 'base64').toString('utf-8'))
              .filter(item => item.trim() !== '')
              .map(item => `<code>${item}</code>`)
              .join(', ');

            function generate_summary(status_header, status_img, status_img_alt, status_img_width, status_quote, additional_info) {
              const header = `<b>${status_header}</b> ${process.env.PR_URL}`;
              const image_body = `<p align='center'> <img src="${status_img}" alt="${status_img_alt}" width="${status_img_width}"> </p>`;
              const quote_body = `<p align="center">${status_quote}</p></br>`;
              const Branch = `<li><b>Branch:</b> <code>${ process.env.PR_Branch }</code></li>`;
              const Title = `<li><b>Title:</b> <code>${ process.env.PR_Title }</code></li>`;
              const Validating_Up_to_Commit = `<li><b>Validating Up to Commit:</b> ${ process.env.PR_SHA }</li>`;
              const Total_Changed_Files = `<li><b>Total Changed Files:</b> <code>${ process.env.PR_Total_changedFiles_count }</code></li>`;
              const Files_Modified = `<li><b>Files Modified:</b><ol>${totalChangedFilesList}</ol></li>`;
              const Commit_Messages = `<li><b>Commit Messages:</b><ol>${commitMessagesList}</ol></li>`;
              const Started_At = `<li><b>Started At:</b> <code>${started_at}</code></li>`;
              const Finished_At = `<li><b>Finished_At At:</b> <code>${finished_At}</code></li>`;
              const Status_footer = `</br><b>Build Target:</b> ${components_build_target}`;

              const Message_body = [
                Branch,
                Title,
                Validating_Up_to_Commit,
                Total_Changed_Files,
                Files_Modified,
                Commit_Messages,
                Started_At,
                Finished_At
                ].join('');

              return [
                header,
                image_body,
                quote_body,
                '<ul>',
                Message_body,
                '</ul>',
                Status_footer,
                '</br><b>', additional_info, '</b>'
              ].join('');
            }

            const status_header = "Validating PR:"
            const status_img = "https://media1.tenor.com/m/t80Qwz2QouMAAAAd/yuru-yuri-ayano-sugiura.gif"
            const status_img_alt = "thinking-test"
            const status_img_width = "200"
            const status_quote = "Take a break, have some rest & grab some water! Meanwhile, we're running tests<br>to ensure the code builds successfully. This won't take long."
            const status_additional_info = "The build Compilation is in Progress"
            const In_progress_Message_summery = generate_summary( status_header, status_img, status_img_alt, status_img_width, status_quote, status_additional_info);


            const check = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Run build Test',
              head_sha: '${{ env.PR_SHA }}',
              external_id: '69',
              status: 'in_progress',
              started_at: new Date().toISOString(),
              output: {
                title: 'Can it pass the build test?..',
                summary: In_progress_Message_summery
              },
            });


      - name: Perform Selective Compilation Task
        id: perform_skip_task
        run: |
          echo "Performing task..."
          echo ${{env.Target_BUILD}}
          sleep 30
          echo "updating status..."
      

      # success
      - name: Create and Run Check(success)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const totalChangedFilesList = JSON.parse(Buffer.from(process.env.PR_Total_changedFiles, 'base64').toString('utf-8'))
              .filter(item => item.trim() !== '')
              .map(item => `<li><code>${item}</code></li>`)
              .join('');

            const commitMessagesList = JSON.parse(Buffer.from(process.env.PR_commits_titel, 'base64').toString('utf-8'))
              .filter(item => item.trim() !== '')
              .map(item => `<li><code>${item}</code></li>`)
              .join('');

            const completedAt = (function() {
              const d = new Date();
              const year = d.getFullYear();
              const month = d.toLocaleString('en-US', { month: 'short' });
              const day = d.getDate();
              const hours = d.getHours();
              const minutes = d.getMinutes();
              const seconds = d.getSeconds();

              return `${year} ${month} ${day}, ${hours}:${minutes}:${seconds}`;
            })();

            const completed_Message_summery = `<b>Validated PR:</b> ${{ env.PR_URL }}
              <p align="center">
                <img src="https://media.tenor.com/0XDvs2JB8RsAAAAj/meiling-thumbs-up.gif" alt="thumbs up good">
              </p>
              <p align="center">
                Build tests went smoothly—good job, friend! Thanks</br> 
                For the hard work and precious Time. Take a well-deserved break, okay?
              </p>

              <ul>
                <li><b>Branch:</b> <code>${{ env.PR_Branch }}</code></li>
                <li><b>Title:</b> <code>${{ env.PR_Title }}</code></li>
                <li><b>Validated Up to Commit:</b> ${{ env.PR_SHA }}</li>
                <li><b>Total Changed Files:</b> <code>${{ env.PR_Total_changedFiles_count }}</code></li>
                <li>
                  <b>Files Modified:</b> 
                  <ol>
                    ${totalChangedFilesList}
                  </ol>
                </li>
                <li>
                  <b>Commit Messages:</b>
                    <ol>
                      ${commitMessagesList}
                    </ol>
                </li>
                <li><b>Started At:</b> <code>${{ env.START_TIME }}</code></li>
                <li><b>Completed At:</b> <code>${completedAt}</code></li>
              </ul> 
              The build compiled successfully`;

            const check = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Run build Test',
              head_sha: '${{ env.PR_SHA }}',
              external_id: '69',
              status: 'completed',
              conclusion: 'success',
              completed_at: new Date().toISOString(),
              output: {
                title: 'Passed the build check successfully',
                summary: completed_Message_summery
              },
            });
