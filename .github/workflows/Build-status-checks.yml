name: Build Status Check

permissions:
  actions: write
  checks: write
  contents: write
  pull-requests: write
  statuses: write

on:
  workflow_dispatch:
    inputs:
      PullRequestLink:
        description: "Enter the Pull Request Link"
        required: true

jobs:
  Context-Preserver:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch PR data
        id: GetPullRequestData
        run: |
          gh pr view "${{ github.event.inputs.PullRequestLink }}" --json number,headRefOid,headRefName,url,title,changedFiles,commits,files > PullRequestData.txt
          if [ $? -ne 0 ]; then
            echo "Error: Failed to fetch PR data."
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Environment
        id: loadEnvironment
        run: |
          echo "PR_NUMBER=$(jq -r '.number' PullRequestData.txt)" >> $GITHUB_ENV
          echo "PR_SHA=$(jq -r '.headRefOid' PullRequestData.txt)" >> $GITHUB_ENV
          echo "PR_URL=$(jq -r '.url' PullRequestData.txt)" >> $GITHUB_ENV
          echo "PR_Branch=$(jq -r '.headRefName' PullRequestData.txt)" >> $GITHUB_ENV
          echo "PR_Title=$(jq -r '.title' PullRequestData.txt)" >> $GITHUB_ENV
          echo "PR_Total_changedFiles_count=$(jq -r '.changedFiles' PullRequestData.txt)" >> $GITHUB_ENV
          echo "PR_Total_changedFiles=$(jq -r '.files | map("`" + .path) |  join("`, ")'  PullRequestData.txt | base64)" >> $GITHUB_ENV
          echo "PR_commits_titel=$( jq -r '.commits | map( "`" + .messageHeadline) |join("`, ")' PullRequestData.txt | base64)" >> $GITHUB_ENV
          echo "START_TIME=$(node -e 'console.log(new Date().toISOString())')" >> $GITHUB_ENV

      - name: Create and Run Check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |

            const TotalChangedFiles = Buffer.from(process.env.PR_Total_changedFiles, 'base64').toString('utf-8');
            const CommitMessages = Buffer.from(process.env.PR_commits_titel, 'base64').toString('utf-8');
            const In_progress_Message_summery = `<br>Validating PR:</br> ${{ env.PR_URL }}
              <p align="center">
                <img src="https://media1.tenor.com/m/t80Qwz2QouMAAAAd/yuru-yuri-ayano-sugiura.gif" alt="thinking-test" width="200">
              </p>
              <p align="center">
                Take a break, have some rest & grab some water! Meanwhile, we're running tests<br>
                to ensure the code builds successfully. This won't take long.
              </p>

              - <b>Branch:</b> \`${{ env.PR_Branch }}\`<br>
              - <b>Title:</b> \`${{ env.PR_Title }}\`<br>
              - <b>Validating Up to Commit:</b> ${{ env.PR_SHA }}<br>
              - <b>Total Changed Files:</b> \`${{ env.PR_Total_changedFiles_count }}\`<br>
              - <b>Files Modified:</b></br> ${TotalChangedFiles}<br>
              - <b>Commit Messages:</b></br> ${CommitMessages}<br>
              - <b>Started At:</b> \`${{ env.START_TIME }}\`<br>
            `;

            const check = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Run build Test',
              head_sha: '${{ env.PR_SHA }}',
              external_id: '69',
              status: 'in_progress',
              started_at: new Date().toISOString(),
              output: {
                title: 'Can it pass the build test?..',
                summary: In_progress_Message_summery
              },
            });

      - name: Perform Task
        id: perform_task
        run: |
          echo "Performing task..."
          sleep 18
          echo "Task completed."

      - name: Create and Run Check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |

            const TotalChangedFiles = Buffer.from(process.env.PR_Total_changedFiles, 'base64').toString('utf-8');
            const CommitMessages = Buffer.from(process.env.PR_commits_titel, 'base64').toString('utf-8');
            const completedAt = new Date().toISOString();

            const completed_Message_summery = `<br>Validated PR:</br> ${{ env.PR_URL }}
              <p align="center">
                <img src="https://media.tenor.com/0XDvs2JB8RsAAAAj/meiling-thumbs-up.gif" alt="thumbs up good">
              </p>
              <p align="center">
                Build tests went smoothlyâ€”good job, friend! Thanks</br> 
                For the hard work and precious Time. Take a well-deserved break, okay?
              </p>

              - <b>Branch:</b> \`${{ env.PR_Branch }}\`<br>
              - <b>Title:</b> \`${{ env.PR_Title }}\`<br>
              - <b>Validating Up to Commit:</b> ${{ env.PR_SHA }}<br>
              - <b>Total Changed Files:</b> \`${{ env.PR_Total_changedFiles_count }}\`<br>
              - <b>Files Modified:</b></br> ${TotalChangedFiles}<br>
              - <b>Commit Messages:</b></br> ${CommitMessages}<br>
              - <b>Started At:</b> \`${{ env.START_TIME }}\`<br>
              - <b>Completed At:</b> \`${completedAt}\`<br><br>
               
              The build compiled successfully`;

            const check = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Run build Test',
              head_sha: '${{ env.PR_SHA }}',
              external_id: '69',
              status: 'completed',
              conclusion: 'success',
              completed_at: completedAt,
              output: {
                title: 'Passed the build check successfully',
                summary: completed_Message_summery
              },
            });
